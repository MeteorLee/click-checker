# 수동 배포 런북 (1.3)

## 0. 목적
- 수동 배포를 1회 완주 가능한 절차로 고정한다.
- 실패 시 즉시 중단/복구 기준을 명확히 한다.

## 1. 배포 순서 (강제)
1. build
2. test
3. deploy(start)
4. health/readiness 확인

> 원칙: 앞 단계가 실패하면 다음 단계로 진행하지 않는다.

## 2. 사전 체크
- 배포 대상 버전(커밋/태그) 확인
- 환경변수/시크릿 확인(DB, SENTRY_DSN 등)
- 롤백 대상(직전 정상 버전) 확인

## 3. 실행 절차
### 3.1 Build
```bash
./gradlew clean bootJar --no-daemon
```

### 3.2 Test
```bash
./gradlew test --no-daemon
```
- 실패 시: 배포 중단

### 3.3 Deploy (앱 기동)
```bash
docker compose up -d --build app postgres prometheus grafana
```

### 3.4 Health / Readiness 확인
```bash
curl -f http://localhost:8080/actuator/health
```
- 성공 기준: HTTP 200 + status=UP

## 4. 기능 스모크 확인
1. Organization 생성 (응답 id를 이후 요청에 사용)
```bash
ORG_ID=$(curl -sS -X POST http://localhost:8080/api/organizations \
  -H 'Content-Type: application/json' \
  -d '{"name":"deploy-check-org"}' | sed -E 's/.*\"id\":([0-9]+).*/\\1/')
echo "ORG_ID=${ORG_ID}"
```

2. 이벤트 저장 1건
```bash
curl -sS -X POST http://localhost:8080/api/events \
  -H 'Content-Type: application/json' \
  -d '{
    "organizationId": '"${ORG_ID}"',
    "eventType": "click",
    "path": "/__test/deploy-check",
    "occurredAt": "2026-02-28T00:00:00"
  }'
```

3. 집계 조회 1건
```bash
curl -sS "http://localhost:8080/api/events/aggregates/paths?organizationId=${ORG_ID}&from=2020-01-01T00:00:00&to=2030-01-01T00:00:00&top=5"
```

## 5. 실패 시 중단/복구 규칙
- build 실패: 즉시 중단
- test 실패: 즉시 중단
- health 실패: 직전 정상 버전으로 롤백

## 6. 롤백 기준 (최소)
- 배포 후 health 미통과 또는 핵심 스모크 실패 시 롤백
- 롤백 대상은 "직전 정상 버전"으로 고정
- 롤백 후 health 재확인

## 7. 완료 판정
- 순서(build→test→deploy→health)를 위반하지 않고 완료
- health 통과
- 이벤트 저장 + 집계 조회 스모크 통과
