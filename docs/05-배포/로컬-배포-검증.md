# 로컬 배포 검증 (1.1)

## 0. 목적
- 로컬에서 배포와 유사한 방식으로 실행하고, 성공/실패를 같은 기준으로 판정한다.

## 1. 배포 성공 기준
- `GET /actuator/health` 가 `200`이고 상태가 `UP`이다.
- `POST /api/events`로 이벤트 1건 저장이 성공한다.
- `GET /api/events/aggregates/paths` 조회가 성공한다.

## 2. 실행 순서
1. 인프라 + 애플리케이션 기동
```bash
docker compose up -d --build app postgres prometheus grafana
```

2. health 확인
```bash
curl -sS http://localhost:8080/actuator/health
```

## 3. 기능 검증 요청
1. Organization 생성
```bash
curl -sS -X POST http://localhost:8080/api/organizations \
  -H 'Content-Type: application/json' \
  -d '{"name":"local-check-org"}'
```

2. Event 저장
```bash
curl -sS -X POST http://localhost:8080/api/events \
  -H 'Content-Type: application/json' \
  -d '{
    "organizationId": 1,
    "externalUserId": "local-user-1",
    "eventType": "click",
    "path": "/__test/local-check",
    "occurredAt": "2026-02-27T00:00:00"
  }'
```

3. Path 집계 조회
```bash
curl -sS "http://localhost:8080/api/events/aggregates/paths?organizationId=1&from=2020-01-01T00:00:00&to=2030-01-01T00:00:00&top=5"
```

## 4. 판정
- 위 3개(health, 저장, 조회)가 모두 성공하면 로컬 배포 검증 통과.
- 하나라도 실패하면 로그 확인 후 재시도.

## 5. 실패 시 확인 포인트
- 앱 로그: `docker compose logs --tail=200 app` (컨테이너 실행 시)
- DB 로그: `docker compose logs --tail=200 postgres`
- Prometheus 타깃: `curl -sS http://localhost:9090/api/v1/targets`
